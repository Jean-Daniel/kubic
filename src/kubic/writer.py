import yaml
from yaml.representer import RepresenterError

from . import KubernetesObject, RawDict, RawList, _TypedList


class KubernetesObjectDumper(yaml.CSafeDumper):
    def represent_undefined(self, data):
        # kubic objects, defaultdict, â€¦
        if isinstance(data, KubernetesObject):
            return self.represent_k8s_object(data)

        if isinstance(data, RawDict):
            return self.represent_dict(data)

        elif isinstance(data, (_TypedList, RawList)):  # _TypedList
            return self.represent_list(data)

        raise RepresenterError("cannot represent an object", data, type(data))

    # see represent_dict()
    def represent_k8s_object(self, obj: KubernetesObject, flow_style=None):
        value = []
        node = yaml.MappingNode("tag:yaml.org,2002:map", value, flow_style=flow_style)
        if self.alias_key is not None:
            self.represented_objects[self.alias_key] = node
        best_style = True
        mapping = obj.items()
        if self.sort_keys:
            try:
                mapping = sorted(mapping)
            except TypeError:
                pass
        for item_key, item_value in mapping:
            # Skipping objets generated by __get__ accessor, but never updated.
            if isinstance(item_value, KubernetesObject) and not _is_dirty(item_value):
                continue

            if isinstance(item_value, _TypedList) and not item_value and not _is_dirty(item_value):
                continue

            # Skipping empty dict if it was generated by __get__ accessor.
            if isinstance(item_value, RawDict) and not item_value:
                continue

            # Skipping empty list if it was generated by __get__ accessor.
            if isinstance(item_value, RawList) and not item_value:
                continue

            node_key = self.represent_data(item_key)
            node_value = self.represent_data(item_value)
            if not (isinstance(node_key, yaml.ScalarNode) and not node_key.style):
                best_style = False
            if not (isinstance(node_value, yaml.ScalarNode) and not node_value.style):
                best_style = False
            value.append((node_key, node_value))
        if flow_style is None:
            if self.default_flow_style is not None:
                node.flow_style = self.default_flow_style
            else:
                node.flow_style = best_style
        return node


def _is_dirty(rsrc: object):
    if isinstance(rsrc, KubernetesObject):
        if rsrc.__dirty:
            return True
        for v in rsrc.values():
            if _is_dirty(v):
                return True
    elif isinstance(rsrc, _TypedList):
        if len(rsrc) > 0 or rsrc.is_dirty:
            return True
    elif isinstance(rsrc, RawDict):
        if len(rsrc) > 0:
            return True
    elif isinstance(rsrc, list):
        if len(rsrc) > 0:
            return True
    return False


KubernetesObjectDumper.add_representer(None, KubernetesObjectDumper.represent_undefined)
